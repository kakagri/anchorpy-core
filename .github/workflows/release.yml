name: Release

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # First, build all wheels by calling the build workflow
  build:
    uses: ./.github/workflows/build.yml

  # Merge all wheel artifacts into a single artifact
  merge-wheels:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Merge wheel artifacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: all-wheels
          pattern: wheels-*
          delete-merged: true

  # Publish to PyPI
  publish-pypi:
    needs: merge-wheels
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write  # For trusted publishing (optional)
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          name: all-wheels
          path: dist/

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --skip-existing dist/*

  # Publish to crates.io (optional, only if CARGO_REGISTRY_TOKEN is set)
  publish-crates:
    needs: merge-wheels
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true  # Don't fail if crates.io token not set
